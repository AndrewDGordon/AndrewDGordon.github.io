!function(){"use strict";const t={type:"Error",basicType:"Error",basicValue:"#NULL!"};function e(t){return{type:"String",basicValue:t}}function n(t){return{type:"Double",basicValue:t}}function r(e){return 0==e.length?t:{type:"Array",elements:e}}const o={};let a=Promise.resolve([]);async function s(t){const e=a.then((()=>async function(t){const e={method:"GET"};if(o[t])return console.log(`Cache hit for ${t}`),o[t];const n=[];let r=0,a=t;for(;null!==a;){const t=Date.now();await new Promise((t=>setTimeout(t,600)));const o=await fetch(a,e);if(!o.ok){console.error(`Error! status: ${o.status}`),a=null;continue}const s=await o.json(),i=Date.now();r+=1,console.log(`Fetched page ${r} in ${(i-t)/1e3}s from ${a} count ${s.count}`),n.push(...s.results),a=s.next||null}return o[t]=n,n}(t)));return a=e.catch((()=>new Error("Error: unexpected exception"))),e}const i={description:"360Giving",logoSourceAddress:"https://www.threesixtygiving.org/wp-content/themes/360giving2020/assets/images/360-logos/360giving-main.svg",logoTargetAddress:"https://360Giving.org"};function c(t){const e=new Date(t);return{type:"FormattedNumber",basicValue:25569+(e.getTime()-60*e.getTimezoneOffset()*1e3)/864e5,numberFormat:"yyyy-mm-dd"}}function l(t,e){return{type:"FormattedNumber",basicValue:t,numberFormat:"GBP"==e?"Â£* #,##0.00":"* #,##0.00",propertyMetadata:{sublabel:e}}}function u(t){const e=t.data,n=l(e.amountAwarded,e.currency),r=e.fundingOrganization.map((t=>t.name)).join(","),o=e.recipientOrganization.map((t=>t.name)).join(","),a=e.fundingOrganization.map((t=>t.id)).join(","),s=e.recipientOrganization.map((t=>t.id)).join(",");return{type:"Entity",text:e.title,properties:{title:e.title,awardDate:c(e.awardDate),funder:r,recipient:o,amountAwarded:n,description:e.description,grant_id:t.grant_id,funder_id:a,recipient_id:s,grant_nav:"https://grantnav.threesixtygiving.org/grant/"+t.grant_id,raw_grant_data:g(t)},layouts:{compact:{icon:"Gift"},card:{title:{property:"title"},sections:[{layout:"List",properties:["awardDate","funder","recipient","amountAwarded","description"]},{layout:"List",title:"More",properties:["grant_id","funder_id","recipient_id","grant_nav","raw_grant_data"],collapsible:!0,collapsed:!0}]}},provider:{description:e.title+" on 360Giving GrantNav",logoSourceAddress:"https://www.threesixtygiving.org/wp-content/themes/360giving2020/assets/images/360-logos/360giving-main.svg",logoTargetAddress:"https://grantnav.threesixtygiving.org/grant/"+t.grant_id}}}function g(e){if(null==e)return t;switch(typeof e){case"boolean":return{type:"Boolean",basicValue:e};case"string":return{type:"String",basicValue:e};case"number":return{type:"Double",basicValue:e};case"object":if(e.constructor===Array){const a=e.length;if(0==a)return t;for(var n=new Array(a),o=0;o<a;o++)n[o]=[p(e[o])];return r(n)}const u=e;var a="",s={};for(var i in u)if(u.hasOwnProperty(i)){for(var c=i.toLowerCase();s.hasOwnProperty(c);)c+="9";const t=u[i];s[c]=g(t);const e=typeof t;var l=c+("boolean"===e||"number"===e||"string"===e?"="+t.toString():"");a=""==a?l:a+","+l}return{type:"Entity",text:a,properties:s};default:return{type:"String",basicValue:"DEFAULT - unexpected"}}}function p(e){if(null==e)return t;const n=g(e);return"object"==typeof e&&e.constructor===Array?{type:"Entity",text:"Nested array",properties:{array:n}}:n}CustomFunctions.associate("ADD",(function(t,e){return t+e+8})),CustomFunctions.associate("CLOCK",(function(t){const e=setInterval((()=>{const e=(new Date).toLocaleTimeString();t.setResult(e)}),1e3);t.onCanceled=()=>{clearInterval(e)}})),CustomFunctions.associate("INCREMENT",(function(t,e){let n=0;const r=setInterval((()=>{n+=t,e.setResult(n)}),1e3);e.onCanceled=()=>{clearInterval(r)}})),CustomFunctions.associate("LOG",(function(t){return console.log(t),t})),CustomFunctions.associate("GRANTS_RECEIVED",(async function(t){const e="https://api.threesixtygiving.org/api/v1/org/"+t+"/grants_received/?limit=100",n=await s(e);if(n instanceof Error)return{type:"Entity",text:`${t} not known to have received grants`,properties:{error:n.message},provider:i};const o=n;return{type:"Entity",text:`${t} received ${n.length} grants`,properties:{grants:r(o.map((t=>[u(t)])))},provider:{description:`${t} on 360Giving`,logoSourceAddress:"https://www.threesixtygiving.org/wp-content/themes/360giving2020/assets/images/360-logos/360giving-main.svg",logoTargetAddress:"https://grantnav.threesixtygiving.org/org/"+t}}})),CustomFunctions.associate("GRANTS_MADE",(async function(t){const e="https://api.threesixtygiving.org/api/v1/org/"+t+"/grants_made/?limit=100",n=await s(e);if(n instanceof Error)return{type:"Entity",text:`${t} not known to have made grants`,properties:{error:n.message},provider:i};const o=n;return{type:"Entity",text:`${t} made ${n.length} grants`,properties:{grants:r(o.map((t=>[u(t)])))},provider:{description:`${t} on 360Giving`,logoSourceAddress:"https://www.threesixtygiving.org/wp-content/themes/360giving2020/assets/images/360-logos/360giving-main.svg",logoTargetAddress:"https://grantnav.threesixtygiving.org/org/"+t}}})),CustomFunctions.associate("WHO_FUNDS_WITH_WHO",(async function(t){const o=[],a=t.length;for(let n=0;n<a;n++){const r=t[n][0].split(";");for(let t=0;t<r.length;t++)for(let n=0;n<r.length;n++)t!==n&&o.push([e(r[t]),e(r[n])])}var s={};for(let t=0;t<o.length;t++){const[e,n]=o[t],r=e.basicValue+";"+n.basicValue;s[r]=(s[r]||0)+1}const i=[];for(const[t,r]of Object.entries(s)){const o=t.split(";");i.push([e(o[0]),e(o[1]),n(r)])}return{type:"Entity",text:"Who funds with who",properties:{who_funds_with_who:r(i)}}})),CustomFunctions.associate("FINDTHATCHARITY",(async function(e){const n="https://findthatcharity.uk/orgid/"+e,r=await fetch(n+".json",{method:"GET"});if(!r.ok)return`Error! status: ${r.status}`;const o=await r.json();return console.log(o),function(e,n){return{type:"Entity",text:n.name,properties:{name:n.name,organisationTypePrimary:n.organisationTypePrimary,description:g(n.description),latestFinancialYearEnd:c(n.latestFinancialYearEnd),latestIncome:null==n.latestIncome?t:l(n.latestIncome,"GBP"),latestSpending:null==n.latestSpending?t:l(n.latestSpending,"GBP"),latestEmployees:g(n.latestEmployees),latestVolunteers:g(n.latestVolunteers),trusteeCount:g(n.trusteeCount),telephone:g(n.telephone),email:g(n.email),location:n.location.map((t=>t.name)).join(","),address:n.address.streetAddress+", "+n.address.addressLocality+", "+n.address.postalCode,url:g(n.url),id:n.id,charityNumber:g(n.charityNumber),companyNumber:g(n.companyNumber),active:{type:"Boolean",basicValue:n.active},dateRegistered:c(n.dateRegistered),dateRemoved:null==n.dateRemoved?"not applicable":c(n.dateRemoved),parent:g(n.parent),organisationType:n.organisationType.join(","),alternateName:n.alternateName.join(","),sources:n.sources.join(","),links:n.links.map((t=>t.site+": "+t.url)).join(","),orgIDs:n.orgIDs.join(","),linked_records:n.linked_records.map((t=>t.orgid+": "+t.url)).join(","),dateModified:c(n.dateModified),raw_charity_data:g(n)},layouts:{compact:{icon:"Organization"},card:{title:{property:"name"},sections:[{layout:"List",properties:["description"]},{layout:"List",title:`${n.active?"Active":"Inactive"} ${n.organisationTypePrimary}, number ${n.charityNumber} since ${n.dateRegistered}`,properties:["id","charityNumber","companyNumber","organisationTypePrimary","active","dateRegistered","dateRemoved","parent","organisationType","alternateName"],collapsible:!0,collapsed:!0},{layout:"List",title:"People and Financials",properties:["latestFinancialYearEnd","latestIncome","latestSpending","latestEmployees","latestVolunteers","trusteeCount"],collapsible:!0,collapsed:!1},{layout:"List",title:"Contact",properties:["telephone","email","address","url"],collapsible:!0,collapsed:!1},{layout:"List",title:"More",properties:["sources","location","links","orgIDs","linked_records","dateModified","raw_charity_data"],collapsible:!0,collapsed:!0}]}},provider:{description:n.name+" on FindThatCharity",logoSourceAddress:"https://www.threesixtygiving.org/wp-content/themes/360giving2020/assets/images/360-logos/360giving-main.svg",logoTargetAddress:e}}}(n,o)})),CustomFunctions.associate("STRING_TO_DATE",c),CustomFunctions.associate("GET_JSON",(async function(t){const e={method:"GET"};try{const n=await fetch(t,e);if(!n.ok)throw new Error(`Error! status: ${n.status}`);return g(await n.json())}catch(t){return console.log(t),g("caught: "+t.message)}})),CustomFunctions.associate("GET_JSON_LINES",(async function(t){const e={method:"GET"};try{const a=await fetch(t,e);if(!a.ok)throw new Error(`Error! status: ${a.status}`);const s=await a.text(),i=await s.split("\n");for(var n=i.length-1,r=new Array(n),o=0;o<n;o++){const t=i[o];try{r[o]=JSON.parse(i[o])}catch(e){r[o]="error parsing: "+t+"length "+t.length}}return g({lines:r})}catch(t){return console.log(t),g("caught: "+t.message)}})),CustomFunctions.associate("POST_JSON",(async function(t,e){const n={method:"POST",headers:{"Content-Type":"application/json"},body:e};try{const e=await fetch(t,n);if(!e.ok)throw new Error(`Error! status: ${e.status}`);return g(await e.json())}catch(t){return console.log(t),g("caught: "+t.message)}})),CustomFunctions.associate("ENCODEURI",(function(t){return encodeURIComponent(t)})),CustomFunctions.associate("PARSE_JSON",(function(t){return g(JSON.parse(t))}))}();
//# sourceMappingURL=functions.js.map